version: 2.1

executors:
  dockcross:
    machine: true
    working_directory: ~/dockcross

commands:
  setup_environment:
    description: Setup custom environment 
    steps:
      - run: 
          name: Export Org and Version
          command: |
            echo "export DOCKCROSS_ORG=$(cat dockcross_org)" >> $BASH_ENV
            echo "export DOCKCROSS_VERSION=$(cat dockcross_version)" >> $BASH_ENV
  build_test_dockcross_image:
    description: Build & test a dockcross container image
    parameters:
      image_name:
        type: string
    steps:
      - restore_cache:
          key: dockcross-base-assets-{{ .Revision }}
      - setup_environment
      - run:
          name: Build << parameters.image_name >>
          no_output_timeout: 1.5h
          command: |
            docker load -i ~/docker/dockcross-base.tar
            make << parameters.image_name >>
            docker save --output ~/docker/<< parameters.image_name >>.tar ${DOCKCROSS_ORG}/<< parameters.image_name >>:${DOCKCROSS_VERSION}
      - run:
         name: Test << parameters.image_name >>
         command: |
            make << parameters.image_name >>.test
      - save_cache:
          key: << parameters.image_name >>-assets-{{ .Revision }}
          paths: ~/docker/<< parameters.image_name >>.tar

  deploy_dockcross_image:
    description: Deploy a dockcross container image
    parameters:
      image_name:
        type: string
    steps:
      - restore_cache:
          key: << parameters.image_name >>-assets-{{ .Revision }}
      - setup_environment
      - deploy:
          name: Deploy << parameters.image_name >>
          command: |
            if [ "${CIRCLE_BRANCH}" == "develop" ]; then
              docker load -i ~/docker/<< parameters.image_name >>.tar
              echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
              docker push ${DOCKCROSS_ORG}/<< parameters.image_name >>:${DOCKCROSS_VERSION}
            fi

references:
  workflow-settings: &workflow-settings
    filters:
      branches:
        only: develop

jobs:
  base:
    executor: dockcross
    steps:
      - checkout
      - setup_environment
      - run:
          name: base build
          command: |
            docker pull debian:10.3-slim
            make base
            mkdir -p ~/docker
            docker save --output ~/docker/dockcross-base.tar debian:10.3-slim ${DOCKCROSS_ORG}/dockcross-base:${DOCKCROSS_VERSION}
      - run:
         name: base test
         command: |
           make base.test
      - save_cache:
          key: dockcross-base-assets-{{ .Revision }}
          paths:
            - ~/docker/dockcross-base.tar
            - ~/dockcross

  make_dockcross:
    description: Invoke the Dockcross Build and Test Command
    parameters:
      image:
        description: "The OCI Container Image Name"
        type: string
    executor: dockcross
    steps:
      - build_test_dockcross_image:
          image_name: << parameters.image >>
      - deploy_dockcross_image:
          image_name: << parameters.image >>

  deploy:
    executor: dockcross
    steps:
      - deploy_dockcross_image:
          image_name: "dockcross-base"

workflows:
  version: 2
  build-test-deploy:
    jobs:
      - base:
          <<: *workflow-settings
      - make_dockcross:
          image: "linux-x64"
          requires:
            - base
      - make_dockcross:
          image: "android-arm"
          requires:
            - base
      - make_dockcross:
          image: "android-arm64"
          requires:
            - base
      - make_dockcross:
          image: "web-wasm"
          requires:
            - base
      - make_dockcross:
          image: "linux-arm64"
          requires:
            - base
      - make_dockcross:
          image: "linux-armv5"
          requires:
            - base
      - make_dockcross:
          image: "linux-armv6"
          requires:
            - base
      - make_dockcross:
          image: "linux-armv7"
          requires:
            - base
      - make_dockcross:
          image: "linux-armv7a"
          requires:
            - base
      # Image build currently broken. See #209
      #- make_dockcross:
      #    image: "linux-mipsel"
      #    requires:
      #      - base
      - make_dockcross:
          image: "linux-s390x"
          requires:
            - base
      - make_dockcross:
          image: "linux-ppc64le"
          requires:
            - base
      - make_dockcross:
          image: "linux-x64"
          requires:
            - base
      - make_dockcross:
          image: "linux-x86"
          requires:
            - base
      - make_dockcross:
          image: "manylinux1-x64"
          requires:
            - base
      - make_dockcross:
          image: "manylinux1-x86"
          requires:
            - base
      - make_dockcross:
          image: "manylinux2010-x64"
          requires:
            - base
      - make_dockcross:
          image: "manylinux2010-x86"
          requires:
            - base
      - make_dockcross:
          image: "manylinux2014-x64"
          requires:
            - base
      - make_dockcross:
          image: "windows-static-x64"
          requires:
            - base
      - make_dockcross:
          image: "windows-static-x64-posix"
          requires:
            - base
      - make_dockcross:
          image: "windows-static-x86"
          requires:
            - base
      - make_dockcross:
          image: "windows-shared-x64"
          requires:
            - base
      - make_dockcross:
          image: "windows-shared-x64-posix"
          requires:
            - base
      - make_dockcross:
          image: "windows-shared-x86"
          requires:
            - base
      - deploy:
          requires:
            - base
